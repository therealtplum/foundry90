services:
  # -------------------------------------------------------------------
  # Postgres – system of record
  # -------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    container_name: fmhub_db
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: fmhub
    ports:
      - "5433:5432"
    volumes:
      - db-data:/var/lib/postgresql/data

  # -------------------------------------------------------------------
  # Redis – cache
  # -------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: fmhub_redis
    ports:
      - "6379:6379"

  # -------------------------------------------------------------------
  # Rust API – Axum service
  # -------------------------------------------------------------------
  api:
    build:
      context: ./apps/rust-api
      dockerfile: Dockerfile
    container_name: fmhub_api
    depends_on:
      - db
      - redis
    environment:
      DATABASE_URL: postgres://app:app@db:5432/fmhub
      REDIS_URL: redis://redis:6379
      RUST_LOG: info

      # LLM insights
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: gpt-4.1-mini

      # System-health → frontend health check
      FRONTEND_HEALTH_URL_LOCAL: "http://fmhub_web:3000/api/version"
      FRONTEND_HEALTH_URL_PROD: "https://www.foundry90.com/api/version"

      # Vercel comparison (prod)
      VERCEL_API_TOKEN: ${VERCEL_API_TOKEN}
      VERCEL_PROJECT_ID: ${VERCEL_PROJECT_ID}
      VERCEL_TEAM_ID: ${VERCEL_TEAM_ID}

      # Allow you to bypass Vercel comparison if needed
      SKIP_VERCEL_COMPARE: ${SKIP_VERCEL_COMPARE}
    volumes:
      - ./logs:/app/logs:ro
    ports:
      - "3000:3000"

  # -------------------------------------------------------------------
  # Python ETL – one-shot ETL jobs
  # -------------------------------------------------------------------
  etl:
    build:
      context: ./apps/python-etl
      dockerfile: Dockerfile
    container_name: fmhub_etl
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://app:app@db:5432/fmhub
      POLYGON_API_KEY: ${POLYGON_API_KEY}
      PRICE_PREV_MAX_INSTRUMENTS: ${PRICE_PREV_MAX_INSTRUMENTS:-2000}
      PRICE_PREV_SLEEP_SECS: ${PRICE_PREV_SLEEP_SECS:-0.02}
      PRICE_PREV_BATCH_SIZE: ${PRICE_PREV_BATCH_SIZE:-500}
      # Kalshi API credentials (for local testing)
      KALSHI_API_KEY_ID: ${KALSHI_API_KEY_ID}
      KALSHI_API_SECRET: ${KALSHI_API_SECRET}
      KALSHI_API_SECRET_FILE: ${KALSHI_API_SECRET_FILE}
      KALSHI_USER_ID: ${KALSHI_USER_ID}
      KALSHI_USE_ENV_CREDS: ${KALSHI_USE_ENV_CREDS:-false}
      KALSHI_BASE_URL: ${KALSHI_BASE_URL:-https://api.elections.kalshi.com/trade-api/v2}
      KALSHI_CREDENTIALS_ENCRYPTION_KEY: ${KALSHI_CREDENTIALS_ENCRYPTION_KEY}
    volumes:
      - ./apps/web/data:/export/web-data
      - ./.env.kalshi_key:/app/.env.kalshi_key:ro
    # Do nothing by default; we trigger jobs with `docker compose run --rm etl ...`
    command: ["sleep", "infinity"]

  # -------------------------------------------------------------------
  # Hadron – Real-time intelligence engine
  # -------------------------------------------------------------------
  hadron:
    build:
      context: ./apps/hadron
      dockerfile: Dockerfile
    container_name: fmhub_hadron
    depends_on:
      - db
      - redis
    environment:
      DATABASE_URL: postgres://app:app@db:5432/fmhub
      POLYGON_API_KEY: ${POLYGON_API_KEY}
      # Multiple API keys for load distribution and redundancy
      HADRON_API_KEY_1: ${HADRON_API_KEY_1:-}
      HADRON_API_KEY_2: ${HADRON_API_KEY_2:-}
      HADRON_API_KEY_3: ${HADRON_API_KEY_3:-}
      HADRON_API_KEY_4: ${HADRON_API_KEY_4:-}
      HADRON_SIMULATION_MODE: ${HADRON_SIMULATION_MODE:-true}
      HADRON_NUM_SHARDS: ${HADRON_NUM_SHARDS:-1}
      HADRON_WEBSOCKET_MODE: ${HADRON_WEBSOCKET_MODE:-delayed}
      # Kalshi API configuration
      KALSHI_API_KEY_1: ${KALSHI_API_KEY_1:-}
      KALSHI_PRIVATE_KEY_1_PATH: ${KALSHI_PRIVATE_KEY_1_PATH:-}
      KALSHI_API_KEY_2: ${KALSHI_API_KEY_2:-}
      KALSHI_PRIVATE_KEY_2_PATH: ${KALSHI_PRIVATE_KEY_2_PATH:-}
      KALSHI_API_KEY_3: ${KALSHI_API_KEY_3:-}
      KALSHI_PRIVATE_KEY_3_PATH: ${KALSHI_PRIVATE_KEY_3_PATH:-}
      KALSHI_API_KEY_4: ${KALSHI_API_KEY_4:-}
      KALSHI_PRIVATE_KEY_4_PATH: ${KALSHI_PRIVATE_KEY_4_PATH:-}
      KALSHI_WS_URL: ${KALSHI_WS_URL:-wss://api.elections.kalshi.com/trade-api/ws/v2}
      KALSHI_USE_DEMO: ${KALSHI_USE_DEMO:-false}
      RUST_LOG: info
      PORT: 3002
    volumes:
      # Mount Kalshi private keys directory
      - ./.kalshi_keys:/app/.kalshi_keys:ro
    ports:
      - "3002:3002"
    restart: unless-stopped

  # -------------------------------------------------------------------
  # Web – Next.js frontend
  # -------------------------------------------------------------------
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        # passed into Dockerfile as ARG GIT_COMMIT / GIT_BRANCH
        GIT_COMMIT: ${GIT_COMMIT:-local-dev}
        GIT_BRANCH: ${GIT_BRANCH:-local-dev}
    container_name: fmhub_web
    depends_on:
      - api
      - db
    environment:
      # How the browser (on your Mac) talks to the Rust API
      NEXT_PUBLIC_API_BASE_URL: "http://localhost:3000"

      # For /api/version → URL field & prod canonical
      NEXT_PUBLIC_SITE_URL: "https://www.foundry90.com"

      # Database connection for email notifications API
      DATABASE_URL: postgres://app:app@db:5432/fmhub

      NODE_ENV: production

      # Optional: also expose git info at runtime (for debugging/logging)
      GIT_COMMIT: ${GIT_COMMIT:-local-dev}
      GIT_BRANCH: ${GIT_BRANCH:-local-dev}
    ports:
      # Host: 3001 → Container: 3000
      - "3001:3000"

volumes:
  db-data: {}